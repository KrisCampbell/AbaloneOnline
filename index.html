<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abalone - Online Multiplayer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 800px;
            width: 90%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        input, button {
            padding: 12px 20px;
            margin: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .game-board {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        
        .board {
            position: relative;
            width: 500px;
            height: 500px;
            background: #8B4513;
            border-radius: 50%;
            border: 10px solid #654321;
        }
        
        .cell {
            position: absolute;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 1px solid #654321;
            background: #D2B48C;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cell:hover {
            background: #F0E68C;
        }
        
        .cell.selected {
            background: #FFD700;
            border: 3px solid #FF6347;
        }
        
        .cell.valid-move {
            background: #90EE90;
        }
        
        .marble {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid #333;
        }
        
        .marble.white {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .marble.black {
            background: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .color-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #333;
        }
        
        .color-indicator.white {
            background: white;
        }
        
        .color-indicator.black {
            background: #333;
        }
        
        .turn-indicator {
            font-weight: bold;
            color: #667eea;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 300px;
            text-align: center;
        }
        
        .lobby-controls {
            margin: 20px 0;
        }
        
        .color-selection {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .color-option {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            border: 2px solid transparent;
            border-radius: 8px;
        }
        
        .color-option.selected {
            border-color: #667eea;
            background: #f0f0f0;
        }
        
        .error {
            color: red;
            margin: 10px 0;
        }
        
        .success {
            color: green;
            margin: 10px 0;
        }

        .lobby-status {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .player-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #ddd;
        }

        .player-slot.host {
            border-left-color: #667eea;
        }

        .player-slot.guest {
            border-left-color: #28a745;
        }

        .player-slot.empty {
            border-left-color: #ccc;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Screen -->
        <div id="homeScreen" class="screen active">
            <h1>üî¥ Abalone Online</h1>
            <div>
                <input type="text" id="usernameInput" placeholder="Enter your username" maxlength="20">
                <div id="usernameError" class="error"></div>
            </div>
            <div>
                <button id="hostBtn">Host Game</button>
                <button id="joinBtn">Join Game</button>
            </div>
            <div id="joinGameDiv" style="display:none;">
                <input type="text" id="gameCodeInput" placeholder="Enter 4-letter game code" maxlength="4">
                <button id="connectBtn">Connect</button>
            </div>
            <div id="connectionError" class="error"></div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobbyScreen" class="screen">
            <h1>Game Lobby</h1>
            <div id="gameCode" class="success"></div>
            
            <div class="lobby-status">
                <h3>Players</h3>
                <div id="hostSlot" class="player-slot host">
                    <span>üè† Host: <strong id="hostName">-</strong></span>
                    <span id="hostColor" class="color-indicator"></span>
                </div>
                <div id="guestSlot" class="player-slot empty">
                    <span>üë§ Guest: <strong id="guestName">Waiting for player...</strong></span>
                    <span id="guestColor" class="color-indicator"></span>
                </div>
            </div>
            
            <div id="colorSelection" class="lobby-controls" style="display:none;">
                <h3>Choose Your Color:</h3>
                <div class="color-selection">
                    <div class="color-option" data-color="white">
                        <div class="color-indicator white"></div>
                        <span>White (First)</span>
                    </div>
                    <div class="color-option" data-color="black">
                        <div class="color-indicator black"></div>
                        <span>Black (Second)</span>
                    </div>
                </div>
            </div>
            
            <div class="lobby-controls">
                <button id="startGameBtn" disabled>Start Game</button>
                <button id="leaveLobbyBtn">Leave Lobby</button>
            </div>
            <div id="lobbyStatus" class="success"></div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen">
            <h1>Abalone</h1>
            <div class="game-info">
                <div class="player-info">
                    <div class="color-indicator white"></div>
                    <span id="whitePlayerName">White Player</span>
                    <span>Captured: <span id="whiteCaptured">0</span></span>
                </div>
                <div class="turn-indicator" id="turnIndicator">White's Turn</div>
                <div class="player-info">
                    <div class="color-indicator black"></div>
                    <span id="blackPlayerName">Black Player</span>
                    <span>Captured: <span id="blackCaptured">0</span></span>
                </div>
            </div>
            
            <div class="game-board">
                <div class="board" id="gameBoard"></div>
            </div>
            
            <div>
                <button id="resetSelectionBtn">Reset Selection</button>
                <button id="leaveGameBtn">Leave Game</button>
            </div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="gameOverModal" class="modal">
        <div class="modal-content">
            <h2 id="gameOverTitle">Game Over!</h2>
            <p id="gameOverMessage"></p>
            <button id="returnToLobbyBtn">Return to Lobby</button>
        </div>
    </div>

    <script>
        // Global game lobbies - simulates server state
        window.gameLobbies = window.gameLobbies || {};

        // Local player state
        let playerState = {
            username: '',
            gameCode: '',
            isHost: false,
            currentScreen: 'home'
        };

        // Game state for current player
        let localGameState = {
            selectedCells: [],
            board: {},
            gameStarted: false
        };

        // Board coordinates - hexagonal grid
        const BOARD_POSITIONS = [];
        
        // Initialize board positions (simplified hexagonal layout)
        function initializeBoardPositions() {
            const center = { x: 250, y: 250 };
            const spacing = 35;
            
            // Create hexagonal grid positions
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    const distance = Math.abs(row - 4) + Math.abs(col - 4);
                    if (distance <= 4) {
                        const x = center.x + (col - 4) * spacing * 0.866;
                        const y = center.y + (row - 4) * spacing * 0.75;
                        BOARD_POSITIONS.push({ 
                            id: `${row}-${col}`, 
                            x: x, 
                            y: y, 
                            row: row, 
                            col: col 
                        });
                    }
                }
            }
        }

        // Initialize game
        function initializeGame() {
            initializeBoardPositions();
            setupEventListeners();
            showScreen('home');
            
            // Start polling for lobby updates
            setInterval(updateLobbyDisplay, 1000);
        }

        // Screen management
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenName + 'Screen').classList.add('active');
            playerState.currentScreen = screenName;
        }

        // Event listeners
        function setupEventListeners() {
            // Home screen
            document.getElementById('hostBtn').addEventListener('click', hostGame);
            document.getElementById('joinBtn').addEventListener('click', showJoinGame);
            document.getElementById('connectBtn').addEventListener('click', joinGame);

            // Lobby screen
            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('leaveLobbyBtn').addEventListener('click', leaveLobby);
            
            // Color selection
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', selectColor);
            });

            // Game screen
            document.getElementById('resetSelectionBtn').addEventListener('click', resetSelection);
            document.getElementById('leaveGameBtn').addEventListener('click', leaveGame);
            document.getElementById('returnToLobbyBtn').addEventListener('click', returnToLobby);
        }

        // Generate random game code
        function generateGameCode() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += letters.charAt(Math.floor(Math.random() * letters.length));
            }
            // Make sure code doesn't already exist
            if (window.gameLobbies[code]) {
                return generateGameCode();
            }
            return code;
        }

        // Host game
        function hostGame() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                document.getElementById('usernameError').textContent = 'Please enter a username';
                return;
            }

            playerState.username = username;
            playerState.gameCode = generateGameCode();
            playerState.isHost = true;
            
            // Create lobby in global state
            window.gameLobbies[playerState.gameCode] = {
                code: playerState.gameCode,
                host: {
                    username: username,
                    color: 'white'
                },
                guest: null,
                gameStarted: false,
                currentTurn: 'white',
                board: {},
                captured: { white: 0, black: 0 }
            };
            
            document.getElementById('gameCode').textContent = `Game Code: ${playerState.gameCode}`;
            document.getElementById('colorSelection').style.display = 'block';
            
            // Default selection
            selectColorOption('white');
            updateLobbyDisplay();
            showScreen('lobby');
        }

        // Show join game input
        function showJoinGame() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                document.getElementById('usernameError').textContent = 'Please enter a username';
                return;
            }
            
            playerState.username = username;
            document.getElementById('joinGameDiv').style.display = 'block';
        }

        // Join game
        function joinGame() {
            const gameCode = document.getElementById('gameCodeInput').value.trim().toUpperCase();
            if (gameCode.length !== 4) {
                document.getElementById('connectionError').textContent = 'Please enter a valid 4-letter game code';
                return;
            }

            // Check if lobby exists
            if (!window.gameLobbies[gameCode]) {
                document.getElementById('connectionError').textContent = 'Game lobby not found';
                return;
            }

            const lobby = window.gameLobbies[gameCode];
            
            // Check if lobby is full
            if (lobby.guest) {
                document.getElementById('connectionError').textContent = 'Game lobby is full';
                return;
            }

            // Join the lobby
            playerState.gameCode = gameCode;
            playerState.isHost = false;
            
            lobby.guest = {
                username: playerState.username,
                color: lobby.host.color === 'white' ? 'black' : 'white'
            };
            
            document.getElementById('gameCode').textContent = `Game Code: ${gameCode}`;
            document.getElementById('connectionError').textContent = '';
            
            updateLobbyDisplay();
            showScreen('lobby');
        }

        // Update lobby display
        function updateLobbyDisplay() {
            if (playerState.currentScreen !== 'lobby' || !playerState.gameCode) return;
            
            const lobby = window.gameLobbies[playerState.gameCode];
            if (!lobby) return;

            // Update host info
            document.getElementById('hostName').textContent = lobby.host.username;
            const hostColorEl = document.getElementById('hostColor');
            hostColorEl.className = `color-indicator ${lobby.host.color}`;

            // Update guest info
            if (lobby.guest) {
                document.getElementById('guestName').textContent = lobby.guest.username;
                const guestColorEl = document.getElementById('guestColor');
                guestColorEl.className = `color-indicator ${lobby.guest.color}`;
                document.getElementById('guestSlot').classList.remove('empty');
                document.getElementById('guestSlot').classList.add('guest');
                
                // Enable start button for host
                if (playerState.isHost) {
                    document.getElementById('startGameBtn').disabled = false;
                }
                
                document.getElementById('lobbyStatus').textContent = 'Both players connected! Host can start the game.';
            } else {
                document.getElementById('guestName').textContent = 'Waiting for player...';
                document.getElementById('guestColor').className = 'color-indicator';
                document.getElementById('guestSlot').classList.add('empty');
                document.getElementById('guestSlot').classList.remove('guest');
                document.getElementById('startGameBtn').disabled = true;
                document.getElementById('lobbyStatus').textContent = 'Waiting for second player to join...';
            }

            // Update color selection visibility
            document.getElementById('colorSelection').style.display = playerState.isHost ? 'block' : 'none';

            // Check if game started
            if (lobby.gameStarted && !localGameState.gameStarted) {
                startLocalGame();
            }
        }

        // Select color (host only)
        function selectColor(event) {
            if (!playerState.isHost) return;
            
            const color = event.currentTarget.dataset.color;
            selectColorOption(color);
        }

        function selectColorOption(color) {
            if (!playerState.isHost) return;
            
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[data-color="${color}"]`).classList.add('selected');
            
            const lobby = window.gameLobbies[playerState.gameCode];
            if (lobby) {
                lobby.host.color = color;
                if (lobby.guest) {
                    lobby.guest.color = color === 'white' ? 'black' : 'white';
                }
                updateLobbyDisplay();
            }
        }

        // Start game (host only)
        function startGame() {
            if (!playerState.isHost) return;
            
            const lobby = window.gameLobbies[playerState.gameCode];
            if (!lobby || !lobby.guest) return;

            lobby.gameStarted = true;
            lobby.currentTurn = 'white';
            lobby.captured = { white: 0, black: 0 };
            
            // Initialize board state
            initializeBoardState(lobby);
            
            startLocalGame();
        }

        // Start local game display
        function startLocalGame() {
            const lobby = window.gameLobbies[playerState.gameCode];
            if (!lobby) return;

            localGameState.gameStarted = true;
            
            // Set player names
            document.getElementById('whitePlayerName').textContent = 
                lobby.host.color === 'white' ? lobby.host.username : lobby.guest.username;
            document.getElementById('blackPlayerName').textContent = 
                lobby.host.color === 'black' ? lobby.host.username : lobby.guest.username;
            
            initializeBoard();
            updateGameDisplay();
            showScreen('game');
        }

        // Initialize board state in lobby
        function initializeBoardState(lobby) {
            lobby.board = {};
            
            // Initialize all positions as empty
            BOARD_POSITIONS.forEach(pos => {
                lobby.board[pos.id] = null;
            });

            // Set initial marble positions
            const whitePositions = [
                '6-2', '6-3', '6-4', '6-5', '6-6',
                '7-2', '7-3', '7-4', '7-5', '7-6',
                '8-3', '8-4', '8-5'
            ];

            const blackPositions = [
                '0-3', '0-4', '0-5',
                '1-2', '1-3', '1-4', '1-5', '1-6',
                '2-2', '2-3', '2-4', '2-5', '2-6'
            ];

            whitePositions.forEach(pos => {
                if (lobby.board.hasOwnProperty(pos)) {
                    lobby.board[pos] = 'white';
                }
            });

            blackPositions.forEach(pos => {
                if (lobby.board.hasOwnProperty(pos)) {
                    lobby.board[pos] = 'black';
                }
            });
        }

        // Initialize board display
        function initializeBoard() {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';
            localGameState.board = {};

            // Create board cells
            BOARD_POSITIONS.forEach(pos => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = pos.id;
                cell.style.left = (pos.x - 12.5) + 'px';
                cell.style.top = (pos.y - 12.5) + 'px';
                cell.addEventListener('click', () => handleCellClick(pos.id));
                board.appendChild(cell);
            });

            // Sync with lobby state
            const lobby = window.gameLobbies[playerState.gameCode];
            if (lobby && lobby.board) {
                Object.keys(lobby.board).forEach(cellId => {
                    const marble = lobby.board[cellId];
                    if (marble) {
                        createMarble(cellId, marble);
                    }
                });
            }
        }

        // Create marble
        function createMarble(cellId, color) {
            const cell = document.getElementById(cellId);
            if (!cell) return;

            // Remove existing marble
            const existingMarble = cell.querySelector('.marble');
            if (existingMarble) {
                existingMarble.remove();
            }

            const marble = document.createElement('div');
            marble.className = `marble ${color}`;
            cell.appendChild(marble);
        }

        // Handle cell click
        function handleCellClick(cellId) {
            const lobby = window.gameLobbies[playerState.gameCode];
            if (!lobby || !lobby.gameStarted) return;

            const cell = document.getElementById(cellId);
            const marble = lobby.board[cellId];

            // Check if it's the player's turn
            const playerColor = playerState.isHost ? lobby.host.color : lobby.guest.color;
            const isPlayerTurn = lobby.currentTurn === playerColor;
            
            if (!isPlayerTurn) return;

            if (marble === playerColor) {
                // Select own marble
                toggleCellSelection(cellId);
            } else if (localGameState.selectedCells.length > 0) {
                // Try to move to this cell
                attemptMove(cellId);
            }
        }

        // Toggle cell selection
        function toggleCellSelection(cellId) {
            const cell = document.getElementById(cellId);
            const index = localGameState.selectedCells.indexOf(cellId);

            if (index === -1) {
                // Add to selection
                localGameState.selectedCells.push(cellId);
                cell.classList.add('selected');
            } else {
                // Remove from selection
                localGameState.selectedCells.splice(index, 1);
                cell.classList.remove('selected');
            }

            // Limit selection to 3 marbles
            if (localGameState.selectedCells.length > 3) {
                const firstSelected = localGameState.selectedCells.shift();
                document.getElementById(firstSelected).classList.remove('selected');
            }

            updateValidMoves();
        }

        // Update valid moves display
        function updateValidMoves() {
            // Clear previous valid moves
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('valid-move');
            });

            if (localGameState.selectedCells.length === 0) return;

            const lobby = window.gameLobbies[playerState.gameCode];
            if (!lobby) return;

            // For simplicity, show all empty adjacent cells as valid moves
            localGameState.selectedCells.forEach(cellId => {
                const neighbors = getNeighbors(cellId);
                neighbors.forEach(neighborId => {
                    if (lobby.board[neighborId] === null) {
                        const cell = document.getElementById(neighborId);
                        if (cell) cell.classList.add('valid-move');
                    }
                });
            });
        }

        // Get neighboring cells
        function getNeighbors(cellId) {
            const [row, col] = cellId.split('-').map(Number);
            const neighbors = [];

            const directions = [
                [-1, 0], [-1, 1], [0, -1], [0, 1], [1, -1], [1, 0]
            ];

            directions.forEach(([dr, dc]) => {
                const newRow = row + dr;
                const newCol = col + dc;
                const newId = `${newRow}-${newCol}`;
                const lobby = window.gameLobbies[playerState.gameCode];
                if (lobby && lobby.board.hasOwnProperty(newId)) {
                    neighbors.push(newId);
                }
            });

            return neighbors;
        }

        // Attempt move
        function attemptMove(targetCellId) {
            const lobby = window.gameLobbies[playerState.gameCode];
            if (!lobby || localGameState.selectedCells.length === 0) return;

            // Simple move validation
            if (lobby.board[targetCellId] === null) {
                const playerColor = playerState.isHost ? lobby.host.color : lobby.guest.color;
                
                // Move marbles (simplified - only moves one marble to target)
                localGameState.selectedCells.forEach(cellId => {
                    lobby.board[cellId] = null;
                    const cell = document.getElementById(cellId);
                    const marble = cell.querySelector('.marble');
                    if (marble) marble.remove();
                });

                // Place marble at target
                lobby.board[targetCellId] = playerColor;
                createMarble(targetCellId, playerColor);

                // Switch turns
                lobby.currentTurn = lobby.currentTurn === 'white' ? 'black' : 'white';
                updateGameDisplay();
                resetSelection();
            }
        }

        // Reset selection
        function resetSelection() {
            localGameState.selectedCells.forEach(cellId => {
                const cell = document.getElementById(cellId);
                if (cell) cell.classList.remove('selected');
            });
            localGameState.selectedCells = [];
            
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('valid-move');
            });
        }

        // Update game display
        function updateGameDisplay() {
            const lobby = window.gameLobbies[playerState.gameCode];
            if (!lobby) return;

            document.getElementById('turnIndicator').textContent = 
                lobby.currentTurn === 'white' ? "White's Turn" : "Black's Turn";
            document.getElementById('whiteCaptured').textContent = lobby.captured.white;
            document.getElementById('blackCaptured').textContent = lobby.captured.black;

            // Check for game end
            if (lobby.captured.white >= 6) {
                endGame('black');
            } else if (lobby.captured.black >= 6) {
                endGame('white');
            }
        }

        // End game
        function endGame(winner) {
            const lobby = window.gameLobbies[playerState.gameCode];
            if (!lobby) return;

            const modal = document.getElementById('gameOverModal');
            const title = document.getElementById('gameOverTitle');
            const message = document.getElementById('gameOverMessage');

            const playerColor = playerState.isHost ? lobby.host.color : lobby.guest.color;
            const playerWon = playerColor === winner;

            title.textContent = playerWon ? 'You Win!' : 'You Lose!';
            message.textContent = `${winner.charAt(0).toUpperCase() + winner.slice(1)} player wins!`;
            
            modal.style.display = 'block';
        }

        // Return to lobby
        function returnToLobby() {
            document.getElementById('gameOverModal').style.display = 'none';
            
            const lobby = window.gameLobbies[playerState.gameCode];
            if (lobby) {
                lobby.gameStarted = false;
            }
            
            localGameState.gameStarted = false;
            updateLobbyDisplay();
            showScreen('lobby');
        }

        // Leave lobby
        function leaveLobby() {
            // Clean up lobby
            if (playerState.gameCode && window.gameLobbies[playerState.gameCode]) {
                const lobby = window.gameLobbies[playerState.gameCode];
                if (playerState.isHost) {
                    // Host leaves - delete entire lobby
                    delete window.gameLobbies[playerState.gameCode];
                } else {
                    // Guest leaves - remove guest
                    lobby.guest = null;
                    lobby.gameStarted = false;
                }
            }

            // Reset player state
            playerState = {
                username: '',
                gameCode: '',
                isHost: false,
                currentScreen: 'home'
            };

            localGameState = {
                selectedCells: [],
                board: {},
                gameStarted: false
            };

            showScreen('home');
            document.getElementById('usernameInput').value = '';
            document.getElementById('gameCodeInput').value = '';
            document.getElementById('joinGameDiv').style.display = 'none';
            document.getElementById('usernameError